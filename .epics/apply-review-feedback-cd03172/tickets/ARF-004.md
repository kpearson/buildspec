# ARF-004: Extract _create_fallback_updates_doc() helper function

## User Stories

**As a** developer debugging failed review feedback application
**I want** fallback documentation created when Claude doesn't update the template
**So that** I have a record of what happened even when Claude fails

**As a** system operator
**I want** fallback documentation to include stdout and stderr logs
**So that** I can diagnose why Claude failed to complete the review feedback

## Acceptance Criteria

1. Function `_create_fallback_updates_doc()` exists in cli/utils/review_feedback.py
2. Function signature matches exactly:
   ```python
   def _create_fallback_updates_doc(targets: ReviewTargets, stdout: str, stderr: str, builder_session_id: str) -> None
   ```
3. Function logic matches the current implementation in create_epic.py (lines 473-522)
4. Fallback doc is written to `targets.artifacts_dir / targets.updates_doc_name`
5. Fallback doc includes frontmatter with complete schema:
   ```yaml
   ---
   date: YYYY-MM-DD
   epic: {targets.epic_name}
   builder_session_id: {builder_session_id}
   reviewer_session_id: {targets.reviewer_session_id}
   status: completed_with_errors
   ---
   ```
6. Fallback doc body includes:
   - Section "## Status": Explains Claude didn't update template, fallback was created
   - Section "## What Happened": Analysis of stdout/stderr
   - Section "## Standard Output": Full stdout content in code block
   - Section "## Standard Error": Full stderr content in code block (if stderr is not empty)
   - Section "## Files Potentially Modified": List of files that may have been edited (detected from stdout if possible)
   - Section "## Next Steps": Guidance on how to verify changes manually
7. Status in frontmatter is set to:
   - "completed_with_errors" if stderr is not empty
   - "completed" if stderr is empty (Claude may have succeeded but didn't update doc)
8. Function analyzes stdout to detect file modifications:
   - Look for patterns like "Edited file: /path/to/file"
   - Look for "Read file" and "Write file" messages
   - Extract file paths and list them in "Files Potentially Modified" section
9. Function has comprehensive docstring explaining:
   - Purpose: Create fallback documentation when Claude fails
   - Parameters: targets, stdout, stderr, builder_session_id
   - Side effects: Writes file to filesystem
   - Analysis: How stdout/stderr are analyzed for insights
10. Type hints present on all parameters and return value
11. File is written with UTF-8 encoding
12. Empty stdout/stderr are handled gracefully (show "No output" instead of empty code blocks)

## Technical Context

This ticket extracts the _create_fallback_updates_doc() function from create_epic.py (lines 473-522). The fallback documentation serves as a safety net when Claude fails to update the template file.

**Failure scenarios:**
1. **Claude crashes**: No documentation created, template still has status=in_progress
2. **Claude completes but doesn't update template**: Files may be edited, but no doc
3. **Claude fails validation**: Returns errors in stderr, may or may not update template

The fallback doc provides critical debugging information:
- **stdout**: Shows what Claude did (file reads, edits, reasoning)
- **stderr**: Shows errors and warnings
- **File detection**: Parses stdout to identify which files were actually modified

The status field helps distinguish scenarios:
- `completed_with_errors`: stderr is not empty (Claude encountered errors)
- `completed`: stderr is empty (Claude may have succeeded silently)

The file detection logic should look for these patterns in stdout:
```
Edited file: /Users/kit/Code/buildspec/.epics/my-epic/my-epic.epic.yaml
Read file: /Users/kit/Code/buildspec/.epics/my-epic/tickets/TICKET-001.md
Wrote file: /Users/kit/Code/buildspec/.epics/my-epic/tickets/TICKET-001.md
```

Extract unique file paths and list them in the fallback doc so developers know what to verify manually.

## Dependencies

**Depends on:**
- ARF-001: Create review_feedback.py utility module with ReviewTargets dataclass

**Blocks:**
- ARF-005: Create main apply_review_feedback() function

## Collaborative Code Context

**Provides to:**
- ARF-005: apply_review_feedback() calls this when template file still has status=in_progress after Claude runs

**Consumes from:**
- ARF-001: ReviewTargets dataclass for file paths and metadata

**Integrates with:**
- Reads stdout and stderr from Claude session (provided by ARF-005)
- Writes to same file path as ARF-003's template (overwrites the template)

## Function Profiles

### `_create_fallback_updates_doc(targets: ReviewTargets, stdout: str, stderr: str, builder_session_id: str) -> None`
Creates fallback documentation when Claude fails to update the template file. Analyzes stdout and stderr to extract insights about what happened. Detects file modifications from stdout patterns. Writes markdown file with frontmatter including completed_with_errors status if stderr is present, or completed if stderr is empty. Includes full stdout/stderr logs and guidance for manual verification.

## Automated Tests

### Unit Tests

- `test_create_fallback_doc_creates_file()` - Verify file is created at correct path
- `test_create_fallback_doc_frontmatter_status_with_errors()` - Verify status is "completed_with_errors" when stderr is not empty
- `test_create_fallback_doc_frontmatter_status_completed()` - Verify status is "completed" when stderr is empty
- `test_create_fallback_doc_includes_stdout()` - Verify stdout is included in code block
- `test_create_fallback_doc_includes_stderr()` - Verify stderr is included when not empty
- `test_create_fallback_doc_omits_stderr_section_when_empty()` - Verify stderr section is omitted when stderr is empty string
- `test_create_fallback_doc_detects_edited_files()` - Verify "Edited file: /path" pattern is detected and listed
- `test_create_fallback_doc_detects_written_files()` - Verify "Wrote file: /path" pattern is detected and listed
- `test_create_fallback_doc_deduplicates_file_paths()` - Verify same file path listed only once even if edited multiple times
- `test_create_fallback_doc_empty_stdout()` - Verify "No output" message when stdout is empty
- `test_create_fallback_doc_empty_stderr()` - Verify stderr section handling when stderr is empty
- `test_create_fallback_doc_includes_next_steps()` - Verify "Next Steps" section provides manual verification guidance
- `test_create_fallback_doc_utf8_encoding()` - Verify file is written with UTF-8 encoding
- `test_create_fallback_doc_frontmatter_date()` - Verify date field uses current date in YYYY-MM-DD format
- `test_create_fallback_doc_frontmatter_epic_name()` - Verify epic field matches targets.epic_name
- `test_create_fallback_doc_frontmatter_session_ids()` - Verify both builder and reviewer session IDs are included
- `test_create_fallback_doc_long_stdout()` - Verify function handles very long stdout (100000+ chars)
- `test_create_fallback_doc_special_chars_in_output()` - Verify special characters in stdout/stderr don't break markdown formatting

### Integration Tests

- `test_create_fallback_doc_roundtrip()` - Create fallback doc, read it back, verify frontmatter is parseable
- `test_create_fallback_doc_matches_create_epic_behavior()` - Verify behavior matches current create_epic.py implementation exactly

### Coverage Target
100% coverage for this function (critical for failure recovery)

**Test Framework**: pytest

**Test Commands**:
```bash
uv run pytest tests/unit/utils/test_review_feedback.py::TestCreateFallbackDoc -v
uv run pytest tests/unit/utils/test_review_feedback.py -v --cov=cli.utils.review_feedback --cov-report=term-missing
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] _create_fallback_updates_doc() function implemented in cli/utils/review_feedback.py
- [ ] Function signature matches specification exactly
- [ ] Logic matches current create_epic.py implementation (lines 473-522)
- [ ] Fallback doc includes complete frontmatter and all required sections
- [ ] File detection from stdout works correctly
- [ ] Status field set correctly based on stderr presence
- [ ] Comprehensive docstring present
- [ ] Type hints on all parameters and return value
- [ ] All tests passing (20 unit + integration tests)
- [ ] Code coverage is 100%
- [ ] Code reviewed
- [ ] No linting errors from ruff

## Non-Goals

- Retrying Claude after failure (review feedback is single attempt per epic non-goals)
- Sending notifications about failures (logging only)
- Automatically fixing errors detected in stderr (manual intervention required)
- Parsing structured error formats from Claude (treat as plain text)
- Validating that detected files actually exist (list them as-is from stdout)
- Creating backups of files before overwriting template (not required per epic non-goals)
- Supporting multiple fallback doc formats (markdown with frontmatter only)
- Adding metrics or telemetry about failure rates (out of scope)
