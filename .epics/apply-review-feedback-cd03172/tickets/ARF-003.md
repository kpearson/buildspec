# ARF-003: Extract _create_template_doc() helper function

## User Stories

**As a** developer applying review feedback
**I want** a template documentation file created before Claude runs
**So that** Claude can replace it with actual documentation of changes made

**As a** system operator monitoring review feedback workflows
**I want** template files to have "status: in_progress" frontmatter
**So that** I can detect when Claude failed to complete the documentation

## Acceptance Criteria

1. Function `_create_template_doc()` exists in cli/utils/review_feedback.py
2. Function signature matches exactly:
   ```python
   def _create_template_doc(targets: ReviewTargets, builder_session_id: str) -> None
   ```
3. Template file is written to `targets.artifacts_dir / targets.updates_doc_name`
4. Parent directories are created if they don't exist (use `Path.mkdir(parents=True, exist_ok=True)`)
5. Template includes frontmatter with this complete schema:
   ```yaml
   ---
   date: YYYY-MM-DD
   epic: {targets.epic_name}
   builder_session_id: {builder_session_id}
   reviewer_session_id: {targets.reviewer_session_id}
   status: in_progress
   ---
   ```
6. Date in frontmatter uses current date in YYYY-MM-DD format
7. Template body includes:
   - Clear message: "Review feedback is being applied..."
   - Instruction: "This template will be replaced by Claude with documentation of changes made"
   - Placeholder sections:
     - "## Changes Applied"
     - "## Files Modified"
     - "## Review Feedback Addressed"
8. Function has comprehensive docstring explaining:
   - Purpose: Create initial template before Claude runs
   - Parameters: targets (configuration), builder_session_id (session ID)
   - Side effects: Writes file to filesystem
   - Why status is in_progress: Enables detection of Claude failures
9. Type hints present on all parameters and return value
10. File is written with UTF-8 encoding
11. Function handles directory creation errors gracefully with clear error messages

## Technical Context

This ticket extracts the template document creation logic from create_epic.py. The template serves a critical role in the review feedback workflow: it's created BEFORE Claude runs, and Claude is instructed to replace it with actual documentation.

The "status: in_progress" frontmatter is key to failure detection. Here's the workflow:

1. **Before Claude**: _create_template_doc() writes template with status=in_progress
2. **Claude runs**: Instructed to replace template with documentation and set status=completed
3. **After Claude**: apply_review_feedback() checks frontmatter status
   - If status=completed → Claude succeeded
   - If status=in_progress → Claude failed, create fallback doc (ARF-004)

The frontmatter schema matches the existing pattern used in create_epic.py:
- `date`: When the review feedback was applied
- `epic`: Name of the epic being modified
- `builder_session_id`: Session ID of the builder (create-epic or create-tickets command)
- `reviewer_session_id`: Session ID of the reviewer (epic-file-review or epic-review)
- `status`: Workflow state (in_progress, completed, completed_with_errors)

This metadata enables traceability: given a documentation file, you can find the corresponding builder and reviewer sessions in logs.

## Dependencies

**Depends on:**
- ARF-001: Create review_feedback.py utility module with ReviewTargets dataclass

**Blocks:**
- ARF-005: Create main apply_review_feedback() function

## Collaborative Code Context

**Provides to:**
- ARF-005: apply_review_feedback() calls this before invoking Claude
- ARF-004: _create_fallback_updates_doc() may read this template to understand what was expected

**Consumes from:**
- ARF-001: ReviewTargets dataclass for file paths and metadata

**Integrates with:**
- The template file is referenced in the prompt built by ARF-002
- The template file is checked by ARF-005 to detect Claude failures

## Function Profiles

### `_create_template_doc(targets: ReviewTargets, builder_session_id: str) -> None`
Writes a template documentation file with frontmatter to the artifacts directory before Claude runs. Creates parent directories if needed. Template includes in_progress status to enable failure detection. Uses current date in YYYY-MM-DD format. Writes UTF-8 encoded markdown with frontmatter and placeholder sections.

## Automated Tests

### Unit Tests

- `test_create_template_doc_creates_file()` - Verify file is created at correct path with temp directory
- `test_create_template_doc_includes_frontmatter()` - Verify frontmatter YAML is present and parseable
- `test_create_template_doc_frontmatter_date_format()` - Verify date field matches YYYY-MM-DD pattern
- `test_create_template_doc_frontmatter_epic_name()` - Verify epic field equals targets.epic_name
- `test_create_template_doc_frontmatter_builder_session_id()` - Verify builder_session_id field is set correctly
- `test_create_template_doc_frontmatter_reviewer_session_id()` - Verify reviewer_session_id equals targets.reviewer_session_id
- `test_create_template_doc_frontmatter_status_in_progress()` - Verify status field is exactly "in_progress"
- `test_create_template_doc_includes_placeholder_sections()` - Verify body has "Changes Applied", "Files Modified", "Review Feedback Addressed" headings
- `test_create_template_doc_creates_parent_directories()` - Verify function creates nested directories if they don't exist
- `test_create_template_doc_overwrites_existing_file()` - Verify function overwrites existing template if called again
- `test_create_template_doc_utf8_encoding()` - Verify file is written with UTF-8 encoding (test with unicode characters)
- `test_create_template_doc_permission_error()` - Verify function raises clear error if directory is not writable
- `test_create_template_doc_disk_full_error()` - Verify function handles OSError when disk is full

### Integration Tests

- `test_create_template_doc_roundtrip()` - Create template, read it back, verify frontmatter can be parsed with yaml.safe_load()
- `test_create_template_doc_with_real_targets()` - Create ReviewTargets with real paths and verify template is created correctly

### Coverage Target
100% coverage for this function (critical for workflow reliability)

**Test Framework**: pytest

**Test Commands**:
```bash
uv run pytest tests/unit/utils/test_review_feedback.py::TestCreateTemplateDoc -v
uv run pytest tests/unit/utils/test_review_feedback.py -v --cov=cli.utils.review_feedback --cov-report=term-missing
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] _create_template_doc() function implemented in cli/utils/review_feedback.py
- [ ] Function signature matches specification exactly
- [ ] Template file includes complete frontmatter schema
- [ ] Directory creation handled correctly
- [ ] Comprehensive docstring present
- [ ] Type hints on all parameters and return value
- [ ] All tests passing (15 unit + integration tests)
- [ ] Code coverage is 100%
- [ ] Code reviewed
- [ ] No linting errors from ruff

## Non-Goals

- Reading or parsing the template file (that's ARF-005's responsibility)
- Validating that Claude successfully replaced the template (that's ARF-005)
- Creating the fallback documentation (that's ARF-004)
- Handling Claude API errors (that's ARF-005)
- Adding file locking or concurrency controls (single-threaded workflow assumed)
- Backing up existing files before overwriting (not required per epic non-goals)
- Adding template versioning (not needed for current use case)
- Customizing template format beyond frontmatter + sections (fixed structure is sufficient)
