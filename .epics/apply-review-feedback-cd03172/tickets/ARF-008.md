# ARF-008: Integrate review feedback into create_tickets.py

## User Stories

**As a** user of the buildspec create-tickets command
**I want** epic-review feedback automatically applied to both epic and ticket files
**So that** I don't have to manually apply review recommendations

**As a** developer maintaining create_tickets.py
**I want** to reuse the shared review_feedback utility
**So that** review feedback application is consistent across create-epic and create-tickets

## Acceptance Criteria

1. Import statement added at top of cli/commands/create_tickets.py:
   ```python
   from cli.utils import ReviewTargets, apply_review_feedback
   ```
2. After invoke_epic_review() succeeds, check if review artifact exists
3. If review artifact exists, create ReviewTargets instance with epic-review configuration:
   ```python
   targets = ReviewTargets(
       primary_file=epic_yaml_path,
       additional_files=ticket_file_paths,  # List of all ticket .md files
       editable_directories=[epic_dir, tickets_dir],
       artifacts_dir=artifacts_dir,
       updates_doc_name="epic-review-updates.md",
       log_file_name="epic-review.log",
       error_file_name="epic-review.error.log",
       epic_name=epic_name,
       reviewer_session_id=reviewer_session_id,
       review_type="epic"
   )
   ```
4. Call apply_review_feedback() with proper error handling:
   ```python
   try:
       apply_review_feedback(
           review_artifact_path=review_artifact_path,
           builder_session_id=builder_session_id,
           context=context,
           targets=targets,
           console=console
       )
   except Exception as e:
       # Review feedback is optional - log warning but don't fail command
       console.print(f"[yellow]Warning: Failed to apply review feedback: {e}[/yellow]")
       # Continue with command execution
   ```
5. ReviewTargets includes epic YAML as primary_file
6. ReviewTargets includes ALL ticket markdown files in additional_files (not just some)
7. ReviewTargets specifies both epic directory and tickets/ subdirectory in editable_directories
8. Error handling is graceful - review feedback failures don't fail the create-tickets command
9. If review artifact doesn't exist, skip review feedback application (no error)
10. Console output shows when review feedback is being applied
11. Net LOC increase of approximately 27 lines in create_tickets.py
12. Epic-review feedback is applied to both epic YAML and all ticket markdown files
13. Documentation artifact (epic-review-updates.md) is created in artifacts directory

## Technical Context

This ticket adds review feedback application to create_tickets.py after epic-review completes. Unlike create_epic.py (which only reviews the epic YAML), create_tickets.py reviews BOTH the epic YAML and all generated ticket files.

**Workflow Integration:**

Current create_tickets.py workflow:
1. Read epic YAML
2. Generate ticket markdown files
3. Invoke epic-review (reviews epic + tickets)
4. **[NEW]** Apply epic-review feedback to epic + tickets
5. Display success message

The review feedback step is inserted after epic-review completes. This is optional - if epic-review wasn't run or failed, we skip feedback application.

**Key Differences from ARF-007 (create_epic.py):**

| Aspect | create_epic.py (ARF-007) | create_tickets.py (ARF-008) |
|--------|--------------------------|------------------------------|
| review_type | "epic-file" | "epic" |
| primary_file | epic YAML only | epic YAML |
| additional_files | Empty list | ALL ticket .md files |
| editable_directories | [epic_dir] | [epic_dir, tickets_dir] |
| updates_doc_name | epic-file-review-updates.md | epic-review-updates.md |
| log_file_name | epic-file-review.log | epic-review.log |

**Extracting ticket_file_paths:**

After tickets are generated, collect all ticket file paths:
```python
ticket_file_paths = []
for ticket in tickets:
    ticket_path = tickets_dir / f"{ticket['id']}.md"
    ticket_file_paths.append(ticket_path)
```

Or use glob:
```python
ticket_file_paths = list(tickets_dir.glob("*.md"))
```

**Error Handling Strategy:**

Review feedback is an *enhancement*, not a requirement. If it fails, we log a warning but continue. The create-tickets command succeeds even if review feedback fails.

Reasons to gracefully handle errors:
- Review artifact might not exist (user didn't run epic-review)
- Claude might fail during feedback application
- Disk might be full when creating documentation
- None of these should prevent ticket generation from succeeding

**Console Output:**

Success:
```
✓ Tickets generated successfully
⠋ Applying epic review feedback...
✓ Review feedback applied to epic and 10 ticket files
  • Documentation: .epics/my-epic/artifacts/epic-review-updates.md
```

Failure (graceful):
```
✓ Tickets generated successfully
⠋ Applying epic review feedback...
⚠ Warning: Failed to apply review feedback: Review artifact not found
  • Tickets are ready to use without review feedback
```

## Dependencies

**Depends on:**
- ARF-006: Update cli/utils/__init__.py exports

**Blocks:**
- ARF-010: Perform integration testing and validation

## Collaborative Code Context

**Provides to:**
- ARF-010: This integration will be tested in integration tests

**Consumes from:**
- ARF-006: Imports ReviewTargets and apply_review_feedback from cli.utils

**Integrates with:**
- Existing create_tickets.py workflow (ticket generation, epic-review invocation)
- Shared review_feedback utility module
- epic-review command (provides review artifact)

## Function Profiles

No new functions are defined - only integration of shared utility into existing workflow.

## Automated Tests

### Unit Tests

- `test_create_tickets_imports_review_feedback_utility()` - Verify imports are present
- `test_create_tickets_creates_review_targets_for_epic_review()` - Verify ReviewTargets created with correct config
- `test_create_tickets_review_targets_includes_all_ticket_files()` - Verify additional_files includes all tickets
- `test_create_tickets_review_targets_review_type_epic()` - Verify review_type is "epic"
- `test_create_tickets_skips_feedback_if_no_artifact()` - Verify no error when review artifact missing
- `test_create_tickets_handles_feedback_failure_gracefully()` - Verify warning logged but command succeeds
- `test_create_tickets_shows_console_output_for_feedback()` - Verify console messages during feedback application

### Integration Tests

- `test_create_tickets_with_epic_review_feedback()` - Run full create-tickets workflow with epic-review, verify both epic and tickets updated
- `test_create_tickets_feedback_updates_epic_yaml()` - Verify epic YAML changes based on review feedback
- `test_create_tickets_feedback_updates_ticket_files()` - Verify ticket markdown files updated based on review feedback
- `test_create_tickets_feedback_creates_documentation()` - Verify epic-review-updates.md created
- `test_create_tickets_without_review_artifact_succeeds()` - Run create-tickets without epic-review, verify no error

### Coverage Target
80% minimum for new code added to create_tickets.py

**Test Framework**: pytest with pytest-mock

**Test Commands**:
```bash
uv run pytest tests/unit/commands/test_create_tickets.py -v
uv run pytest tests/integration/test_create_tickets_workflow.py -v
uv run pytest tests/ -k create_tickets -v --cov=cli.commands.create_tickets --cov-report=term-missing
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Import statement added for ReviewTargets and apply_review_feedback
- [ ] ReviewTargets created after epic-review with correct configuration
- [ ] ReviewTargets includes epic YAML as primary_file
- [ ] ReviewTargets includes all ticket markdown files in additional_files
- [ ] ReviewTargets specifies both epic and tickets directories in editable_directories
- [ ] apply_review_feedback() called with proper error handling
- [ ] Epic-review feedback applied to both epic and ticket files
- [ ] Errors handled gracefully without failing command
- [ ] Console output shows feedback application status
- [ ] Net LOC increase of ~27 lines achieved
- [ ] All tests passing (7 unit + 5 integration tests)
- [ ] Code coverage meets 80% minimum
- [ ] Code reviewed
- [ ] No linting errors from ruff

## Non-Goals

- Making review feedback mandatory (it's optional enhancement)
- Implementing epic-review command (already exists)
- Changing ticket generation logic
- Modifying epic-review prompt or criteria
- Adding retry logic for failed review feedback (single attempt per epic non-goals)
- Validating review feedback was applied correctly (trust Claude)
- Creating diff reports of changes made (Claude's edits are direct)
- Supporting selective ticket updates (all tickets updated or none)
- Adding configuration options for review feedback behavior
- Changing error messages from shared utility
