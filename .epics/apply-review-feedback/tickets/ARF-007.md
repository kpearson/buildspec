# ARF-007: Refactor create_epic.py to use shared utility

## User Stories

**As a** developer maintaining create_epic.py
**I want** the local apply_review_feedback() function removed in favor of the shared utility
**So that** review feedback logic is maintained in one place and stays consistent

**As a** user of the buildspec create-epic command
**I want** the epic-file-review workflow to continue working identically
**So that** my existing workflows are not disrupted by the refactoring

## Acceptance Criteria

1. Local `apply_review_feedback()` function removed from cli/commands/create_epic.py (lines 524-760 approximately)
2. Local `_create_fallback_updates_doc()` function removed from cli/commands/create_epic.py (lines 473-522 approximately)
3. Import statement added at top of create_epic.py:
   ```python
   from cli.utils import ReviewTargets, apply_review_feedback
   ```
4. At the call site (where apply_review_feedback used to be called), create ReviewTargets instance:
   ```python
   targets = ReviewTargets(
       primary_file=epic_file_path,
       additional_files=[],
       editable_directories=[epic_dir],
       artifacts_dir=artifacts_dir,
       updates_doc_name="epic-file-review-updates.md",
       log_file_name="epic-file-review.log",
       error_file_name="epic-file-review.error.log",
       epic_name=epic_name,
       reviewer_session_id=reviewer_session_id,
       review_type="epic-file"
   )
   ```
5. Call shared apply_review_feedback() with correct parameters:
   ```python
   apply_review_feedback(
       review_artifact_path=review_artifact_path,
       builder_session_id=builder_session_id,
       context=context,
       targets=targets,
       console=console
   )
   ```
6. Epic file review workflow continues to work identically to before refactoring
7. All function parameters are extracted from existing create_epic.py context (epic_file_path, epic_dir, artifacts_dir, epic_name, reviewer_session_id, builder_session_id, context, console)
8. Net LOC reduction of approximately 272 lines in create_epic.py (removing ~286 lines, adding ~14 lines)
9. No behavioral changes - output, error handling, logging all identical to before
10. Existing tests for create_epic.py still pass without modification
11. Code follows project style (80 char line length, double quotes)

## Technical Context

This ticket performs the actual refactoring in create_epic.py to use the shared utility. The current implementation has:
- Local apply_review_feedback() at lines 524-760 (~236 lines)
- Local _create_fallback_updates_doc() at lines 473-522 (~50 lines)
- Total: ~286 lines to remove

The refactoring replaces these with:
- Import statement (~1 line)
- ReviewTargets instantiation (~11 lines)
- Function call (~7 lines)
- Total: ~19 lines to add

Net reduction: ~267 lines

**Key Implementation Details:**

**Finding the call site:**
Search for where apply_review_feedback is currently called in create_epic.py. It should be after epic-file-review completes and the review artifact exists.

**Extracting parameters for ReviewTargets:**
- `primary_file`: The epic YAML file path (variable like epic_file_path or epic_yaml_path)
- `additional_files`: Empty list (epic-file review only edits epic YAML)
- `editable_directories`: List containing epic directory (where epic YAML lives)
- `artifacts_dir`: Subdirectory where review artifacts are stored
- `updates_doc_name`: "epic-file-review-updates.md" (hardcoded string from current impl)
- `log_file_name`: "epic-file-review.log" (hardcoded string from current impl)
- `error_file_name`: "epic-file-review.error.log" (hardcoded string from current impl)
- `epic_name`: Epic name extracted from epic YAML or directory name
- `reviewer_session_id`: Session ID from epic-file-review invocation
- `review_type`: "epic-file" (literal string)

**Extracting parameters for apply_review_feedback():**
- `review_artifact_path`: Path to epic-file-review artifact (variable like review_artifact_path)
- `builder_session_id`: Session ID of current create-epic command
- `context`: ClaudeContext instance (variable like context or claude_context)
- `targets`: The ReviewTargets instance created above
- `console`: Rich Console instance (variable like console)

**Error Handling:**
The shared utility handles all errors, so no try/except needed at call site. Just call the function directly.

**Testing:**
After refactoring, run existing create_epic.py tests to ensure nothing broke. No test modifications should be needed if behavior is identical.

## Dependencies

**Depends on:**
- ARF-006: Update cli/utils/__init__.py exports

**Blocks:**
- ARF-010: Perform integration testing and validation

## Collaborative Code Context

**Provides to:**
- ARF-010: This refactored code will be tested in integration tests

**Consumes from:**
- ARF-006: Imports ReviewTargets and apply_review_feedback from cli.utils

**Integrates with:**
- Existing create_epic.py workflow (epic creation, epic-file-review invocation)
- Shared review_feedback utility module

## Function Profiles

No new functions are defined - only refactoring existing function calls to use shared utility.

## Automated Tests

### Unit Tests

Since this is pure refactoring, existing tests should pass without modification. New tests to add:

- `test_create_epic_calls_shared_apply_review_feedback()` - Use pytest-mock to verify shared function called (not local one)
- `test_create_epic_creates_correct_review_targets()` - Verify ReviewTargets instantiated with correct parameters for epic-file review
- `test_create_epic_review_targets_has_empty_additional_files()` - Verify additional_files is empty list for epic-file review
- `test_create_epic_review_targets_review_type_epic_file()` - Verify review_type is "epic-file"

### Integration Tests

- `test_create_epic_workflow_with_review_feedback()` - Run full create-epic command with review feedback, verify epic YAML updated
- `test_create_epic_review_feedback_creates_documentation()` - Verify epic-file-review-updates.md created
- `test_create_epic_behavior_identical_to_before_refactoring()` - Compare output and side effects to baseline before refactoring

### Regression Tests

- Run all existing create_epic.py tests and verify they pass without modification

### Coverage Target
No coverage change expected (replacing local code with shared utility call)

**Test Framework**: pytest with pytest-mock

**Test Commands**:
```bash
uv run pytest tests/unit/commands/test_create_epic.py -v
uv run pytest tests/integration/test_create_epic_workflow.py -v
uv run pytest tests/ -k create_epic -v --cov=cli.commands.create_epic --cov-report=term-missing
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Local apply_review_feedback() function removed from create_epic.py
- [ ] Local _create_fallback_updates_doc() function removed
- [ ] Import statement added for ReviewTargets and apply_review_feedback
- [ ] ReviewTargets instance created at call site with correct parameters
- [ ] Shared apply_review_feedback() called with correct parameters
- [ ] Net LOC reduction of ~267 lines achieved
- [ ] Epic file review workflow works identically to before
- [ ] All existing tests pass without modification
- [ ] New tests pass (4 unit tests + 3 integration tests)
- [ ] Code reviewed
- [ ] No linting errors from ruff

## Non-Goals

- Changing behavior of epic-file-review workflow (must be identical)
- Modifying epic-file-review command implementation
- Changing error messages or console output
- Adding new features to create_epic.py
- Refactoring other parts of create_epic.py beyond review feedback
- Changing variable names or code style (only remove/add code for refactoring)
- Modifying existing tests (should pass as-is)
- Adding logging beyond what shared utility provides
- Changing file paths or artifact naming conventions
